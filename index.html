<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Simple Python Block Programming</title>

    <style>
      .block {
        border: 1px solid #555;
        padding: 10px;
        margin: 5px;
        cursor: pointer;
        background-color: #f9f9f9;
      }
      #modules {
        padding: 10px;
        border: 2px solid #000;
      }
      #workspace {
        border: 2px solid #000;
        padding: 10px;
        height: 300px;
        overflow: auto;
      }
      .input {
        margin: 0 5px;
        padding: 2px 4px;
      }
      code {
        display: block;
        white-space: pre-wrap;
        background-color: #f9f9f9;
        padding: 10px;
        margin-top: 10px;
      }

      .container-fluid {
        padding: 10px;
      }
    </style>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <!-- simple blocks side by side -->
    <div class="container-fluid">
      <div class="row">
        <div id="modules" class="col-3">
          <!-- Modules will be populated here -->

          <!-- Each module will contain blocks -->
        </div>

        <div class="col-9">
          <div id="workspace">
            <!-- User drags blocks here -->
          </div>
          <code id="python-code"></code>
        </div>
      </div>
    </div>

    <style>
      /* Add style for input fields within blocks */
      .input {
        margin: 0 5px;
        padding: 2px 4px;
      }
    </style>
    <script>
      // Assuming module_info is loaded somehow, e.g., embedded or fetched
      const module_info = {
        classes: {
          A: {
            methods: {
              b: {
                parameters: [],
              },
            },
          },
        },
        functions: {
          c: {
            parameters: ["x"],
          },
        },
      };

      function initBlocks(blocksContainer, moduleInfo, moduleName) {
        // Populate functions
        for (const [funcName, funcInfo] of Object.entries(
          moduleInfo.functions
        )) {
          const block = document.createElement("div");
          block.className = "block";
          block.innerHTML = `Function: ${funcName}(`;
          funcInfo.parameters.forEach((param, index) => {
            if (index > 0) block.appendChild(document.createTextNode(", "));
            const input = document.createElement("input");
            input.className = "input";
            input.placeholder = param;
            input.setAttribute("data-param", param); // Set data attribute
            block.appendChild(input);
          });
          block.appendChild(document.createTextNode(")"));
          block.draggable = true;
          block.setAttribute("data-type", "function"); // Indicate the type of block
          block.setAttribute("data-name", funcName); // Indicate the function name
          block.setAttribute("data-module-name", moduleName); // Indicate the module name
          block.ondragstart = drag;
          blocksContainer.appendChild(block);
        }

        // Populate classes and methods
        for (const [className, classInfo] of Object.entries(
          moduleInfo.classes
        )) {
          for (const [methodName, methodInfo] of Object.entries(
            classInfo.methods
          )) {
            const block = document.createElement("div");
            block.className = "block";
            block.innerHTML = `Method: ${className}.${methodName}(`;
            methodInfo.parameters.forEach((param, index) => {
              if (index > 0) block.appendChild(document.createTextNode(", "));
              const input = document.createElement("input");
              input.className = "input";
              input.placeholder = param;
              input.setAttribute("data-param", param);
              block.appendChild(input);
            });
            block.appendChild(document.createTextNode(")"));
            block.draggable = true;
            block.setAttribute("data-type", "method"); // Indicate the type of block
            block.setAttribute("data-class", className); // Indicate the class name
            block.setAttribute("data-method", methodName); // Indicate the method name
            block.setAttribute("data-module-name", moduleName); // Indicate the module name
            block.ondragstart = drag;
            blocksContainer.appendChild(block);
          }
        }

        // Populate variable assignment where the user can input the variable name and value
        const block = document.createElement("div");
        block.className = "block";
        block.textContent = "Variable: ";
        const inputVarName = document.createElement("input");
        inputVarName.className = "input";
        inputVarName.placeholder = "name";
        block.appendChild(inputVarName);
        block.appendChild(document.createTextNode(" = "));
        const inputVarValue = document.createElement("input");
        inputVarValue.className = "input";
        inputVarValue.placeholder = "value";
        block.appendChild(inputVarValue);
        block.draggable = true;
        block.setAttribute("data-type", "variable"); // Indicate the type of block
        block.ondragstart = drag;
        blocksContainer.appendChild(block);
      }

      function initModules() {
        const modulesContainer = document.getElementById("modules");

        // Populate modules
        for (const [moduleName, moduleInfo] of [
          [
            "math",
            {
              functions: {
                sqrt: {
                  parameters: ["x"],
                },
                pow: {
                  parameters: ["x", "y"],
                },
              },
              classes: [],
            },
          ],
          [
            "random",
            {
              functions: {
                randint: {
                  parameters: ["a", "b"],
                },
              },
              classes: [],
            },
          ],
          ["custom", module_info],
        ]) {
          const module = document.createElement("div");
          module.className = "module";
          module.draggable = true;
          module.ondragstart = drag;
          modulesContainer.appendChild(module);

          const moduleHeader = document.createElement("div");
          moduleHeader.className = "module-header";
          moduleHeader.textContent = moduleName;
          module.appendChild(moduleHeader);

          // Populate functions
          const blocksContainer = document.createElement("div");
          blocksContainer.className = "blocks";
          module.appendChild(blocksContainer);
          initBlocks(blocksContainer, moduleInfo, moduleName);

          // Add collapse/expand functionality
          moduleHeader.onclick = () => {
            blocksContainer.classList.toggle("collapse");
          };
        }
      }

      function drag(ev) {
        ev.dataTransfer.setData("text/html", ev.target.outerHTML); // Use outerHTML to include element markup
      }

      function allowDrop(ev) {
        ev.preventDefault();

        if (ev.target.className === "block" || ev.target.id === "workspace") {
          ev.target.style.background = "#f0f0f0"; // Example: Change background color
        }
      }

      function drop(ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text/html");
        if (ev.target.id === "workspace" || ev.target.className === "block") {
          // var nodeCopy = document.createElement("div");
          // nodeCopy.innerHTML = data;
          // nodeCopy.contentEditable = "true"; // Allow editing inside dropped block
          // ev.target.appendChild(nodeCopy);

          var data = ev.dataTransfer.getData("text/html");
          var tempDiv = document.createElement("div");
          tempDiv.innerHTML = data;
          var nodeCopy = tempDiv.firstChild;

          // Check if dropping on another block or just in the workspace
          if (ev.target.className === "block") {
            // Determine cursor position to drop before or after
            const targetRect = ev.target.getBoundingClientRect();
            const dropPosition = ev.clientY - targetRect.top;
            if (dropPosition < targetRect.height / 2) {
              ev.target.parentNode.insertBefore(nodeCopy, ev.target); // Drop before
            } else {
              ev.target.parentNode.insertBefore(
                nodeCopy,
                ev.target.nextSibling
              ); // Drop after
            }
          } else {
            ev.target.appendChild(nodeCopy);
          }

          exportPython(); // Update Python code

          // Add event listener to update Python code when the user edits the block
          nodeCopy.addEventListener("input", exportPython);
        }
      }

      function exportPython() {
        const blocks = document.querySelectorAll("#workspace .block");
        let code = "";
        blocks.forEach((block) => {
          const inputs = block.querySelectorAll("input");
          const values = Array.from(inputs).map(
            (input) => input.value || `"${input.placeholder}"`
          );
          if (block.dataset.type === "function") {
            code += `${block.dataset.moduleName}.${
              block.dataset.name
            }(${values.join(", ")})\n`;
          } else if (block.dataset.type === "method") {
            code += `${block.dataset.moduleName}.${block.dataset.class}.${
              block.dataset.method
            }(${values.join(", ")})\n`;
          } else if (block.dataset.type === "variable") {
            code += `${values[0]} = ${values[1]}\n`;
          }
        });
        document.getElementById("python-code").textContent = code;
      }

      document.getElementById("workspace").ondrop = drop;
      document.getElementById("workspace").ondragover = allowDrop;

      window.onload = initModules;
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
