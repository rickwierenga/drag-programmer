<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Simple Python Block Programming</title>

    <style>
      .block {
        border: 1px solid #555;
        padding: 10px;
        margin: 5px;
        cursor: pointer;
        background-color: #f9f9f9;
      }
      #modules {
        padding: 10px;
        border: 2px solid #000;
      }
      #workspace {
        border: 2px solid #000;
        padding: 10px;
        height: 300px;
        overflow: auto;
      }
      #workspace.drag-over {
        border: 2px dashed #000;
      }
      code {
        display: block;
        white-space: pre-wrap;
        background-color: #f9f9f9;
        padding: 10px;
        margin-top: 10px;
      }

      #modules .module {
        margin-bottom: 10px;
      }

      .module-header {
        cursor: pointer;
        background-color: #f0f0f0;
        padding: 5px;
      }

      .module-header i {
        margin-right: 5px;
      }

      .module i.open {
        display: inline-block;
      }
      .module i.close {
        display: none;
      }

      .module.hidden i.open {
        display: none;
      }
      .module.hidden i.close {
        display: inline-block;
      }

      .module.hidden .blocks {
        display: none;
      }

      .container-fluid {
        padding: 10px;
      }

      .block .parameters {
        display: inline;
      }

      .param-holder {
        border: 2px dashed #ff00ff;
        border-radius: 10px;
        padding: 5px 10px;
      }

      .param-holder.drag-over {
        background-color: #ff00ff;
      }

      .block[data-type="assign-variable"] .variable-name-input,
      .block-variable {
        background-color: #ffccff;
        border-radius: 10px;
        border: 1px solid #ff00ff;
        padding-left: 10px;
      }
      .block .block-variable {
        display: inline-block;
        padding: 5px 10px;
      }
    </style>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div id="modules" class="col-3"></div>

        <div class="col-9">
          <div id="workspace">
            <!-- User drags blocks here -->
          </div>
          <code id="python-code"></code>
        </div>
      </div>
    </div>

    <!-- templates -->

    <template id="sidebar-module-template">
      <div class="module">
        <div class="module-header" onclick="toggleModule(this)">
          <i class="bi bi-caret-down open"></i>
          <i class="bi bi-caret-right close"></i>
          <span class="module-name"></span>
        </div>

        <div class="blocks"></div>
      </div>
    </template>

    <template id="block-template-function">
      <div class="block" draggable="true" data-type="function">
        <span class="function-name"></span>
        (
        <div class="parameters"></div>
        )
      </div>
    </template>

    <template id="block-template-variable">
      <div class="block block-variable" draggable="true" data-type="variable">
        <span class="variable-name"></span>
      </div>
    </template>

    <template id="block-template-assign-variable">
      <div class="block" draggable="true" data-type="assign-variable">
        <input
          class="variable-name-input"
          type="text"
          placeholder="variable name"
        />
        =
        <input
          class="variable-value-input"
          type="text"
          placeholder="variable value"
        />
      </div>
    </template>

    <script>
      class Block {
        constructor(type, moduleName) {
          this.type = type;
          this.moduleName = moduleName;
          this.id = crypto.randomUUID();
        }

        serialize() {
          return {
            id: this.id,
            type: this.type,
            moduleName: this.moduleName,
          };
        }

        render() {
          throw new Error("Not implemented");
        }

        writeLine() {
          throw new Error("Not implemented");
        }
      }

      class FunctionBlock extends Block {
        constructor(module, name, parameters) {
          super("function", module);
          this.name = name;
          this.parameters = parameters.map((param) => ({
            id: crypto.randomUUID(),
            name: param.name,
            value: param.value,
          }));
        }

        serialize() {
          return {
            ...super.serialize(),
            name: this.name,
            parameters: this.parameters.map((param) => ({
              id: param.id,
              name: param.name,
              value: param.value,
            })),
          };
        }

        render() {
          const template = document.getElementById("block-template-function");
          const block = template.content
            .cloneNode(true)
            .querySelector(".block");

          block.dataset.data = JSON.stringify(this.serialize());

          block.querySelector(".function-name").textContent = this.name;
          const parameterEl = block.querySelector(".parameters");
          for (
            let paramIdx = 0;
            paramIdx < this.parameters.length;
            paramIdx++
          ) {
            let parameter = this.parameters[paramIdx];
            const paramHolder = document.createElement("span");
            if (parameter.value !== undefined) {
              paramHolder.innerHTML = parameter.value.render().outerHTML;
            } else {
              paramHolder.classList.add("param-holder");
              paramHolder.textContent = parameter.name;
            }
            paramHolder.dataset.id = parameter.id;
            paramHolder.ondragover = allowDrop;
            paramHolder.ondrop = dropParam;
            parameterEl.appendChild(paramHolder);

            if (paramIdx < this.parameters.length - 1) {
              parameterEl.appendChild(document.createTextNode(", "));
            }
          }

          return block;
        }

        writeLine() {
          let parameterString = this.parameters
            .map((param) =>
              param.value ? param.value.writeLine() : param.name
            )
            .join(", ");
          return `${this.moduleName}.${this.name}(${parameterString})`;
        }
      }

      class VariableBlock extends Block {
        constructor(name) {
          super("variable", undefined);
          this.name = name;
        }

        serialize() {
          return {
            ...super.serialize(),
            name: this.name,
          };
        }

        render() {
          const template = document.getElementById("block-template-variable");
          const block = template.content
            .cloneNode(true)
            .querySelector(".block");

          block.dataset.data = JSON.stringify(this.serialize());

          block.querySelector(".variable-name").textContent = this.name;

          return block;
        }

        writeLine() {
          return this.name;
        }
      }

      class VariableAssignmentBlock extends Block {
        constructor(variable, value) {
          super("assign-variable", undefined);
          this.variable = variable;
          this.value = value;
        }

        serialize() {
          return {
            ...super.serialize(),
            variable: this.variable,
            value: this.value,
          };
        }

        render() {
          const template = document.getElementById(
            "block-template-assign-variable"
          );
          const block = template.content
            .cloneNode(true)
            .querySelector(".block");

          block.dataset.data = JSON.stringify(this.serialize());

          const nameInput = block.querySelector(".variable-name-input");
          nameInput.onchange = (e) => {
            this.variable.name = e.target.value;
            renderWorkspace(program);
            renderProgram(program);
          };
          if (this.variable) {
            nameInput.value = this.variable.name;
          }

          const valueInput = block.querySelector(".variable-value-input");
          valueInput.onchange = (e) => {
            this.value = e.target.value;
            renderWorkspace(program);
            renderProgram(program);
          };
          if (this.value) {
            block.querySelector(".variable-value-input").value = this.value;
          }

          return block;
        }

        writeLine() {
          return `${this.variable.name} = ${this.value}`;
        }
      }
    </script>

    <script>
      function addBlockToSidebar(module, block) {
        const renderedBlock = block.render();
        renderedBlock.ondragstart = dragFromSidebar;
        module.querySelector(".blocks").appendChild(renderedBlock);
      }

      function addModuleToSidebar(moduleData) {
        const template = document.getElementById("sidebar-module-template");
        const module = template.content
          .cloneNode(true)
          .querySelector(".module");
        module.querySelector(".module-name").textContent = moduleData.name;

        // functions
        if (moduleData.functions) {
          for (const functionData of moduleData.functions) {
            const { name, parameters } = functionData;
            let functionBlock = new FunctionBlock(
              moduleData.name,
              name,
              parameters.map((param) => ({
                name: param,
                value: undefined,
              }))
            );
            addBlockToSidebar(module, functionBlock);
          }
        }

        // variables
        if (moduleData.variables) {
          for (const variableData of moduleData.variables) {
            const { name } = variableData;
            let variableBlock = new VariableBlock(name);
            addBlockToSidebar(module, variableBlock);
          }
        }

        document.getElementById("modules").appendChild(module);
      }

      let globalModule;
      function addGlobalModule() {
        const template = document.getElementById("sidebar-module-template");
        globalModule = template.content
          .cloneNode(true)
          .querySelector(".module");
        globalModule.querySelector(".module-name").textContent = "global";

        let variableAssignmentBlock = new VariableAssignmentBlock(
          undefined,
          undefined
        );
        addBlockToSidebar(globalModule, variableAssignmentBlock);

        document.getElementById("modules").appendChild(globalModule);
      }

      // load from /api
      function loadModules() {
        addGlobalModule();

        fetch("/api")
          .then((response) => response.json())
          .then((data) => {
            for (const module of data) {
              addModuleToSidebar(module);
            }
          });
      }

      window.onload = loadModules;

      function toggleModule(moduleHeader) {
        const module = moduleHeader.parentElement;
        module.classList.toggle("hidden");
      }
    </script>

    <script>
      // drag and drop

      let program = [];
      let variables = [];

      function renderWorkspace(program) {
        document.getElementById("workspace").innerHTML = "";
        for (const block of program) {
          const blockElement = block.render();
          document.getElementById("workspace").appendChild(blockElement);
        }

        // remove all variables, to be re-added after this
        for (const variableEl of globalModule.querySelectorAll(
          ".block[data-type='variable']"
        )) {
          variableEl.remove();
        }
        for (const variableBlock of variables) {
          addBlockToSidebar(globalModule, variableBlock);
        }
      }

      function renderProgram(program) {
        exportPython(program);
      }

      function resetDrag() {
        document.getElementById("workspace").classList.remove("drag-over");
        for (const paramHolder of document.querySelectorAll(".param-holder")) {
          paramHolder.classList.remove("drag-over");
        }
      }

      const DRAG_EVENT_TYPE = {
        NEW_BLOCK: "new-block",
        // MOVE_BLOCK: "move-block",
        USE_VARIABLE: "use-variable",
      };

      let dragEventData;

      function dragFromSidebar(ev) {
        if (ev.target.dataset.type === "variable") {
          const blockData = JSON.parse(ev.target.dataset.data);
          let variable = variables.find((v) => v.id === blockData.id);
          dragEventData = {
            type: DRAG_EVENT_TYPE.USE_VARIABLE,
            variable: variable,
          };
        } else {
          dragEventData = {
            type: DRAG_EVENT_TYPE.NEW_BLOCK,
            block_data: JSON.parse(ev.target.dataset.data),
          };
        }
      }

      function allowDrop(ev) {
        ev.preventDefault();
        resetDrag();
        if (
          ev.target.id === "workspace" &&
          dragEventData.type === DRAG_EVENT_TYPE.NEW_BLOCK
        ) {
          document.getElementById("workspace").classList.add("drag-over");
        } else if (
          ev.target.classList.contains("param-holder") &&
          dragEventData.type === DRAG_EVENT_TYPE.USE_VARIABLE
        ) {
          ev.target.classList.add("drag-over");
        }
      }

      function getNewUnusedVariableName() {
        let i = 0;
        while (variables.find((v) => v.name === `var${i}`)) i++;
        return `var${i}`;
      }

      function createBlock(blockData) {
        let block;
        if (blockData.type === "function") {
          const { moduleName, name, parameters } = blockData;
          block = new FunctionBlock(moduleName, name, parameters);
        } else if (blockData.type === "assign-variable") {
          const { variable, value } = blockData;
          const variableBlock = new VariableBlock(getNewUnusedVariableName());
          variables.push(variableBlock);
          block = new VariableAssignmentBlock(variableBlock, value);
        } else {
          throw new Error("Unknown block type", blockData);
        }
        return block;
      }

      function dropWorkspace(ev) {
        ev.preventDefault();
        resetDrag();

        if (ev.target.id !== "workspace") {
          return;
        }

        if (dragEventData.type === DRAG_EVENT_TYPE.NEW_BLOCK) {
          const blockData = dragEventData.block_data;
          block = createBlock(blockData);
          program.push(block);

          renderWorkspace(program);
          renderProgram(program);
        } else {
          console.error("Unknown drag event type", dragEventData);
        }
      }

      function findParamHolderById(id, blockList) {
        for (const block of blockList) {
          if (block.type !== "function") continue;

          for (paramHolder of block.parameters.filter(
            (param) => param.value === undefined
          )) {
            if (paramHolder.id === id) return paramHolder;
          }

          const paramBlock = findParamHolderById(
            id,
            block.parameters
              .filter((param) => param.value)
              .map((param) => param.value)
          );
          if (paramBlock) {
            return paramBlock;
          }
        }
        return null;
      }

      function dropParam(ev) {
        ev.preventDefault();
        ev.stopPropagation();
        resetDrag();

        if (dragEventData.type === DRAG_EVENT_TYPE.USE_VARIABLE) {
          const paramHolder = ev.target;
          const paramId = paramHolder.dataset.id;

          let block = findParamHolderById(paramId, program);
          if (block) {
            block.value = dragEventData.variable;
          }

          renderWorkspace(program);
          renderProgram(program);
        } else {
          console.error("Unknown drag event type", dragEventData);
        }
      }

      function exportPython(program) {
        let code = "";

        // gather modules
        let modules = new Set();
        for (let block of program) {
          if (block.moduleName !== undefined) {
            modules.add(block.moduleName);
          }
        }
        modules = Array.from(modules).sort();
        for (let i = 0; i < modules.length; i++) {
          code += `import ${modules[i]}\n`;
        }

        code += "\n";

        for (let block of program) {
          code += block.writeLine() + "\n";
        }

        document.getElementById("python-code").textContent = code;
      }

      document.getElementById("workspace").ondrop = dropWorkspace;
      document.getElementById("workspace").ondragover = allowDrop;
      document.getElementById("workspace").ondragleave = resetDrag;
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
