<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Simple Python Block Programming</title>

    <style>
      .block {
        border: 1px solid #555;
        padding: 10px;
        margin: 5px;
        cursor: pointer;
        background-color: #f9f9f9;
      }
      #modules {
        padding: 10px;
        border: 2px solid #000;
      }
      #workspace {
        border: 2px solid #000;
        padding: 10px;
        height: 300px;
        overflow: auto;
      }
      .input {
        margin: 0 5px;
        padding: 2px 4px;
      }
      code {
        display: block;
        white-space: pre-wrap;
        background-color: #f9f9f9;
        padding: 10px;
        margin-top: 10px;
      }

      #modules .module {
        margin-bottom: 10px;
      }

      .module-header {
        cursor: pointer;
        background-color: #f0f0f0;
        padding: 5px;
      }

      .module-header i {
        margin-right: 5px;
      }

      .module i.open {
        display: inline-block;
      }
      .module i.close {
        display: none;
      }

      .module.hidden i.open {
        display: none;
      }
      .module.hidden i.close {
        display: inline-block;
      }

      .module.hidden .blocks {
        display: none;
      }

      .container-fluid {
        padding: 10px;
      }

      .param-holder {
        /* soft yellow */
        background-color: #ffffcc;
        padding: 2px 4px;
        margin: 0 2px;
      }
    </style>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <!-- simple blocks side by side -->
    <div class="container-fluid">
      <div class="row">
        <div id="modules" class="col-3"></div>

        <div class="col-9">
          <div id="workspace">
            <!-- User drags blocks here -->
          </div>
          <code id="python-code"></code>
        </div>
      </div>
    </div>

    <!-- templates -->

    <template id="sidebar-module-template">
      <div class="module">
        <div class="module-header" onclick="toggleModule(this)">
          <i class="bi bi-caret-down open"></i>
          <i class="bi bi-caret-right close"></i>
          <span class="module-name"></span>
        </div>

        <div class="blocks"></div>
      </div>
    </template>

    <template id="block-template-function">
      <div class="block" draggable="true" data-type="function">
        <span class="function-name"></span>
        (
        <span class="param-holder"></span>
        ,
        <span class="param-holder"></span>
        )
      </div>
    </template>

    <template id="block-template-method">
      <div class="block" draggable="true" data-type="method">
        <span class="class-name"></span>
        .
        <span class="method-name"></span>
        (
        <span class="param-holder"></span>
        ,
        <span class="param-holder"></span>
        )
      </div>
    </template>

    <template id="block-template-variable">
      <div class="block" draggable="true" data-type="variable">
        <span class="variable-name"></span>
        =
        <span class="variable-value"></span>
      </div>
    </template>

    <script>
      function addModuleToSidebar(moduleData) {
        console.log(moduleData);

        const template = document.getElementById("sidebar-module-template");
        const module = template.content
          .cloneNode(true)
          .querySelector(".module");

        module.querySelector(".module-name").textContent = moduleData.name;

        // functions
        for (const functionData of moduleData.functions) {
          functionData.type = "function";
          functionData.moduleName = module.name;
          addFunctionBlockToSidebar(module, functionData);
        }

        // classes
        for (const classData of moduleData.classes) {
          for (const methodData of classData.methods) {
            methodData.type = "method";
            methodData.className = classData.name;
            methodData.moduleName = moduleData.name;
            addMethodBlockToSidebar(module, methodData);
          }
        }

        // variables
        for (const variableData of moduleData.variables) {
          variableData.type = "variable";
          variableData.moduleName = moduleData.name;
          addVariableBlockToSidebar(module, variableData);
        }

        document.getElementById("modules").appendChild(module);
      }

      // loading data and adding to sidebar
      function addBlockToSidebar(module, block) {
        block.ondragstart = drag;
        module.querySelector(".blocks").appendChild(block);
      }

      function addFunctionBlockToSidebar(module, functionData) {
        block = renderFunctionBlock(functionData);
        addBlockToSidebar(module, block);
      }

      function addMethodBlockToSidebar(module, methodData) {
        block = renderMethodBlock(methodData);
        addBlockToSidebar(module, block);
      }

      function addVariableBlockToSidebar(module, variableData) {
        block = renderVariableBlock(variableData);
        addBlockToSidebar(module, block);
      }

      // load from /api
      function loadModules() {
        fetch("/api")
          .then((response) => response.json())
          .then((data) => {
            for (const module of data) {
              addModuleToSidebar(module);
            }
          });
      }

      window.onload = loadModules;

      function toggleModule(moduleHeader) {
        const module = moduleHeader.parentElement;
        module.classList.toggle("hidden");
      }
    </script>

    <script>
      // rendering block templates
      function renderFunctionBlock(functionData) {
        const { name: functionName, parameters } = functionData;

        const template = document.getElementById("block-template-function");
        const block = template.content.cloneNode(true).querySelector(".block");

        block.dataset.data = JSON.stringify(functionData);
        block.querySelector(".function-name").textContent = functionName;
        block.querySelectorAll(".param-holder").forEach((paramHolder, i) => {
          if (parameters[i]) {
            paramHolder.textContent = parameters[i];
          }
        });

        return block;
      }

      function renderMethodBlock(methodData) {
        const { className, name: methodName, parameters } = methodData;

        const template = document.getElementById("block-template-method");
        const block = template.content.cloneNode(true).querySelector(".block");

        block.dataset.data = JSON.stringify(methodData);

        block.querySelector(".class-name").textContent = className;
        block.querySelector(".method-name").textContent = methodName;
        block.querySelectorAll(".param-holder").forEach((paramHolder, i) => {
          if (parameters[i]) {
            paramHolder.textContent = parameters[i];
          }
        });

        return block;
      }

      function renderVariableBlock(variableData) {
        const { name: variableName, value } = variableData;

        const template = document.getElementById("block-template-variable");
        const block = template.content.cloneNode(true).querySelector(".block");

        block.dataset.data = JSON.stringify(variableData);

        block.querySelector(".variable-name").textContent = variableName;
        block.querySelector(".variable-value").textContent = value;

        return block;
      }
    </script>

    <script>
      // drag and drop

      function addFunctionBlockToWorkspace(functionData) {
        block = renderFunctionBlock(functionData);
        document.getElementById("workspace").appendChild(block);
        exportPython();
      }

      function addMethodBlockToWorkspace(methodData) {
        block = renderMethodBlock(methodData);
        document.getElementById("workspace").appendChild(block);
        exportPython();
      }

      function addVariableBlockToWorkspace(variableData) {
        block = renderVariableBlock(variableData);
        document.getElementById("workspace").appendChild(block);
        exportPython();
      }

      function drag(ev) {
        const data = ev.target.dataset.data;
        ev.dataTransfer.setData("text/json", data);
      }

      function allowDrop(ev) {
        ev.preventDefault();

        if (ev.target.className === "block" || ev.target.id === "workspace") {
          ev.target.style.background = "#f0f0f0"; // Example: Change background color
        }
      }

      function drop(ev) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text/json");
        if (ev.target.id === "workspace") {
          const { type } = JSON.parse(data);

          if (type === "function") {
            addFunctionBlockToWorkspace(JSON.parse(data));
          } else if (type === "method") {
            addMethodBlockToWorkspace(JSON.parse(data));
          } else if (type === "variable") {
            addVariableBlockToWorkspace(JSON.parse(data));
          } else {
            console.error("Unknown block type", data);
            return;
          }

          exportPython(); // Update Python code

          // Add event listener to update Python code when the user edits the block
          nodeCopy.addEventListener("input", exportPython);
        }
      }

      function exportPython() {
        const blocks = document.querySelectorAll("#workspace .block");
        let code = "";

        // gather modules
        let modules = new Set();
        for (let i = 0; i < blocks.length; i++) {
          const data = JSON.parse(blocks[i].dataset.data);
          const { moduleName } = data;
          modules.add(moduleName);
        }
        modules = Array.from(modules).sort();
        for (let i = 0; i < modules.length; i++) {
          code += `import ${modules[i]}\n`;
        }

        code += "\n";

        // write actual code
        blocks.forEach((block) => {
          const inputs = block.querySelectorAll("input");
          const values = Array.from(inputs).map(
            (input) => input.value || `"${input.placeholder}"`
          );
          const data = JSON.parse(block.dataset.data);
          if (block.dataset.type === "function") {
            const { moduleName, name } = data;
            code += `${moduleName}.${name}(${values.join(", ")})\n`;
          } else if (block.dataset.type === "method") {
            const { moduleName, className, name: methodName } = data;
            code += `${moduleName}.${className}.${methodName}(${values.join(
              ", "
            )})\n`;
          } else if (block.dataset.type === "variable") {
            const { name, value } = data;
            code += `${name} = ${value}\n`;
          }
        });
        document.getElementById("python-code").textContent = code;
      }

      document.getElementById("workspace").ondrop = drop;
      document.getElementById("workspace").ondragover = allowDrop;
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
